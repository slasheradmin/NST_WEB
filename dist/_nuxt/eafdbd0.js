(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{1047:function(e,t,r){"use strict";r.r(t);var n=r(485),o=r(672),c=r(663),l=r(657),d=r(662),m=r(899),f=r(1040),w=r(238),v=r(192),h=r(656),x=r(1046),k=r(654),_=r(836),O=r(1039),j=(r(14),r(76),r(4)),y=r(11),D=(r(51),r(42),r(18),r(55),r(87),r(52),r(19),r(20),r(16),r(6),r(67),r(15),r(915)),R=r.n(D),I=(r(917),r(138)),F=r(159),C=(r(489),r(487),r(2)),L=r.n(C);function N(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function U(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?N(Object(r),!0).forEach((function(t){Object(j.a)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):N(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var E={components:{VueCropper:R.a},layout:"admin_appbar",data:function(){return{searchQuery:"",dialog:!1,cropperDialog:!1,editing:!1,editingId:null,news:{title:"",description:"",category:"",image:"",time:null,oldImage:null},newsList:[],categories:["ประชาสัมพันธ์","การผลิต","ลูกค้าและพันธมิตร","งานแสดงสินค้า","การรับรองคุณภาพ"],loading:!1,snackbar:{message:"",color:""}}},computed:{filteredNews:function(){var e=this;return this.newsList.filter((function(t){return t.title.toLowerCase().includes(e.searchQuery.toLowerCase())}))}},methods:Object(j.a)(Object(j.a)(Object(j.a)(Object(j.a)(Object(j.a)(Object(j.a)(Object(j.a)(Object(j.a)({truncateDescription:function(e){return e&&e.length>70?e.substring(0,70)+"...":e},truncateTitle:function(title){return title&&title.length>40?title.substring(0,40)+"...":title},fetchNews:function(){var e=this;return Object(y.a)(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,I.a.collection("news").orderBy("time","desc").get();case 2:r=t.sent,e.newsList=r.docs.map((function(e){return U({id:e.id},e.data())}));case 4:case"end":return t.stop()}}),t)})))()},openDialog:function(){this.resetForm(),this.dialog=!0},closeDialog:function(){this.dialog=!1,this.resetForm()},closeCropperDialog:function(){this.cropperDialog=!1},editNews:function(e){this.editing=!0,this.editingId=e.id,this.news=U(U({},e),{},{oldImage:e.image}),this.dialog=!0},handleImageUpload:function(e){var t=this;if(e){this.news.image="",this.news.imageFile=null;var r=new FileReader;r.onload=function(e){t.news.image=e.target.result,t.cropperDialog=!0},r.readAsDataURL(e)}},cropImage:function(){var e=this;this.$refs.cropper.getCroppedCanvas().toBlob((function(t){e.news.imageFile=t;var r=new FileReader;r.onload=function(t){e.news.image=t.target.result},r.readAsDataURL(t),e.closeCropperDialog()}),"image/jpeg")},close:function(){this.dialog=!1,this.resetForm()},resetForm:function(){this.news={title:"",description:"",category:"",image:"",time:null,oldImage:null},this.editing=!1,this.editingId=null},saveNews:function(){var e=this;return Object(y.a)(regeneratorRuntime.mark((function t(){var r,n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.news.imageFile||e.news.image){t.next=3;break}return alert("กรุณาครอปภาพหรือเลือกภาพใหม่ก่อนบันทึก"),t.abrupt("return");case 3:if(e.loading=!0,t.prev=4,r=e.news.image,!e.news.imageFile){t.next=15;break}if(!e.editing||!e.news.oldImage){t.next=10;break}return t.next=10,e.deleteOldImage(e.news.oldImage);case 10:return t.next=12,e.uploadImage(e.news.imageFile);case 12:if(r=t.sent){t.next=15;break}throw new Error("อัปโหลดรูปภาพไม่สำเร็จ");case 15:if(n={title:e.news.title,description:e.news.description,category:e.news.category,image:r,time:e.editing?e.news.time:F.default.firestore.FieldValue.serverTimestamp()},!e.editing){t.next=21;break}return t.next=19,I.a.collection("news").doc(e.editingId).update(n);case 19:t.next=23;break;case 21:return t.next=23,I.a.collection("news").add(n);case 23:e.snackbar.message=e.editing?"บันทึกการแก้ไขข่าวสำเร็จ":"เพิ่มข่าวสำเร็จ",e.snackbar.color="success",e.fetchNews(),e.closeDialog(),t.next=33;break;case 29:t.prev=29,t.t0=t.catch(4),e.snackbar.message="เกิดข้อผิดพลาด: ".concat(t.t0.message),e.snackbar.color="error";case 33:return t.prev=33,e.loading=!1,t.finish(33);case 36:case"end":return t.stop()}}),t,null,[[4,29,33,36]])})))()},deleteOldImage:function(e){return Object(y.a)(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=F.default.storage().refFromURL(e),t.next=4,r.delete();case 4:t.next=9;break;case 6:t.prev=6,t.t0=t.catch(0),console.error("Error deleting old image:",t.t0);case 9:case"end":return t.stop()}}),t,null,[[0,6]])})))()},uploadImage:function(e){return Object(y.a)(regeneratorRuntime.mark((function t(){var r,n,o,c;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=F.default.storage().ref(),n="news_images/".concat(Date.now(),"_").concat(e.name),o=r.child(n),t.prev=3,t.next=6,o.put(e);case 6:return c=t.sent,t.next=9,c.ref.getDownloadURL();case 9:return t.abrupt("return",t.sent);case 12:return t.prev=12,t.t0=t.catch(3),console.error("Error uploading image:",t.t0),t.abrupt("return",null);case 16:case"end":return t.stop()}}),t,null,[[3,12]])})))()}},"handleImageUpload",(function(e){var t=this;if(e){this.news.image="",this.news.imageFile=null;var r=new FileReader;r.onload=function(e){t.news.image=e.target.result,t.cropperDialog=!0},r.readAsDataURL(e)}})),"cropImage",(function(){var e=this;this.$refs.cropper.getCroppedCanvas().toBlob((function(t){e.news.imageFile=t;var r=new FileReader;r.onload=function(t){e.news.image="",e.news.image=t.target.result},r.readAsDataURL(t),e.closeCropperDialog()}),"image/jpeg")})),"deleteOldImage",(function(e){return Object(y.a)(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=F.default.storage().refFromURL(e),t.next=4,r.delete();case 4:t.next=9;break;case 6:t.prev=6,t.t0=t.catch(0),console.error("Error deleting old image:",t.t0);case 9:case"end":return t.stop()}}),t,null,[[0,6]])})))()})),"uploadImage",(function(e){return Object(y.a)(regeneratorRuntime.mark((function t(){var r,n,o,c;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=F.default.storage().ref(),n="news_images/".concat(Date.now(),"_").concat(e.name),o=r.child(n),t.prev=3,t.next=6,o.put(e);case 6:return c=t.sent,t.next=9,c.ref.getDownloadURL();case 9:return t.abrupt("return",t.sent);case 12:return t.prev=12,t.t0=t.catch(3),console.error("Error uploading image:",t.t0),t.abrupt("return",null);case 16:case"end":return t.stop()}}),t,null,[[3,12]])})))()})),"deleteOldImage",(function(e){return Object(y.a)(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=F.default.storage().refFromURL(e),t.next=4,r.delete();case 4:t.next=9;break;case 6:t.prev=6,t.t0=t.catch(0),console.error("Error deleting old image:",t.t0);case 9:case"end":return t.stop()}}),t,null,[[0,6]])})))()})),"deleteNews",(function(e){var t=this;return Object(y.a)(regeneratorRuntime.mark((function r(){return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(confirm("คุณแน่ใจหรือไม่ว่าต้องการลบข่าวนี้?")){r.next=3;break}return r.abrupt("return");case 3:if(r.prev=3,!e.image){r.next=7;break}return r.next=7,t.deleteOldImage(e.image);case 7:return r.next=9,I.a.collection("news").doc(e.id).delete();case 9:t.snackbar.message="ลบข่าวสำเร็จ",t.snackbar.color="success",t.fetchNews(),r.next=19;break;case 14:r.prev=14,r.t0=r.catch(3),console.error("Error deleting news:",r.t0),t.snackbar.message="เกิดข้อผิดพลาด: ".concat(r.t0.message),t.snackbar.color="error";case 19:case"end":return r.stop()}}),r,null,[[3,14]])})))()})),"resetForm",(function(){this.news={title:"",description:"",category:"",image:"",time:null,oldImage:null},this.editing=!1,this.editingId=null})),"formatTimestamp",(function(e){return e&&e.seconds?L.a.unix(e.seconds).fromNow():"-"})),mounted:function(){"true"===localStorage.getItem("isLoggedIn")||this.$router.push("/login"),this.fetchNews()}},P=r(86),component=Object(P.a)(E,(function(){var e=this,t=e._self._c;return t(d.a,[t(h.a,[t(l.a,{attrs:{cols:"12"}},[t(o.a,{staticClass:"pa-4"},[t(c.d,[e._v("\n          จัดการข่าวสาร\n          "),t(k.a),e._v(" "),t(n.a,{attrs:{color:"primary"},on:{click:e.openDialog}},[e._v("เพิ่มข่าว")])],1),e._v(" "),t(h.a,[t(l.a,{staticClass:"d-flex justify-end",attrs:{cols:"12",sm:"12"}},[t(_.a,{staticClass:"mb-4",staticStyle:{"max-width":"300px"},attrs:{label:"ค้นหาข่าว",outlined:"",clearable:"",dense:""},model:{value:e.searchQuery,callback:function(t){e.searchQuery=t},expression:"searchQuery"}})],1)],1),e._v(" "),t(h.a,e._l(e.filteredNews,(function(r){return t(l.a,{key:r.id,attrs:{cols:"12",sm:"6",md:"4"}},[t(o.a,{staticClass:"mb-4 d-flex flex-column"},[t(v.a,{staticClass:"ma-4",attrs:{src:r.image,height:"300px",width:"auto",contain:""}}),e._v(" "),t(c.d,[e._v("\n                "+e._s(e.truncateTitle(r.title))+"\n              ")]),e._v(" "),t(c.b,[e._v(e._s(e.formatTimestamp(r.time)))]),e._v(" "),t(c.c,{staticClass:"flex-grow-1"},[e._v("\n                "+e._s(e.truncateDescription(r.description))+"\n              ")]),e._v(" "),t(c.a,[t(n.a,{attrs:{icon:""},on:{click:function(t){return e.editNews(r)}}},[t(w.a,[e._v("mdi-pencil")])],1),e._v(" "),t(n.a,{attrs:{icon:"",color:"red"},on:{click:function(t){return e.deleteNews(r)}}},[t(w.a,[e._v("mdi-delete")])],1)],1)],1)],1)})),1)],1)],1)],1),e._v(" "),t(m.a,{attrs:{"max-width":"600px"},model:{value:e.dialog,callback:function(t){e.dialog=t},expression:"dialog"}},[t(o.a,[t(c.d,[e._v(e._s(e.editing?"แก้ไขข่าว":"เพิ่มข่าว"))]),e._v(" "),t(c.c,[t(_.a,{attrs:{label:"หัวข้อข่าว",required:""},model:{value:e.news.title,callback:function(t){e.$set(e.news,"title",t)},expression:"news.title"}}),e._v(" "),t(O.a,{attrs:{label:"รายละเอียดข่าว",required:""},model:{value:e.news.description,callback:function(t){e.$set(e.news,"description",t)},expression:"news.description"}}),e._v(" "),t(x.a,{attrs:{items:e.categories,label:"หมวดหมู่ข่าว",required:""},model:{value:e.news.category,callback:function(t){e.$set(e.news,"category",t)},expression:"news.category"}}),e._v(" "),t(f.a,{staticClass:"my-4",attrs:{label:"เลือกรูปภาพ",accept:"image/*",outlined:"",dense:""},on:{change:e.handleImageUpload}}),e._v(" "),e.news.image?t(v.a,{staticClass:"mt-4",attrs:{src:e.news.image,"max-height":"200px",contain:""}}):e._e()],1),e._v(" "),t(c.a,[t(n.a,{attrs:{text:""},on:{click:e.closeDialog}},[e._v("ยกเลิก")]),e._v(" "),t(n.a,{attrs:{color:"primary",loading:e.loading,disabled:e.loading||!e.news.image},on:{click:e.saveNews}},[e._v("บันทึก")])],1)],1)],1),e._v(" "),t(m.a,{attrs:{"max-width":"600px"},model:{value:e.cropperDialog,callback:function(t){e.cropperDialog=t},expression:"cropperDialog"}},[t(o.a,[t(c.d,[e._v("ครอปรูปภาพ")]),e._v(" "),t(c.c,[t("vue-cropper",{ref:"cropper",attrs:{src:e.news.image,"aspect-ratio":370/301,"auto-crop":""}})],1),e._v(" "),t(c.a,[t(n.a,{attrs:{text:""},on:{click:e.closeCropperDialog}},[e._v("ยกเลิก")]),e._v(" "),t(n.a,{attrs:{color:"green"},on:{click:e.cropImage}},[e._v("ครอป")])],1)],1)],1)],1)}),[],!1,null,null,null);t.default=component.exports}}]);